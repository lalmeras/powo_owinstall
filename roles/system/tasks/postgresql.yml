- name: postgresql
  package: pkg={{ item }}
  with_items:
      - postgresql
      - postgresql-client
      - postgresql-contrib

- name: /var/lib/postgresql symlink
  file:
      path: /var/lib/postgresql
      state: link
      src: /data/services/postgresql
  ignore_errors: true
  register: var_postgresql_link

- block:
    - name: stopping postgresql
      service: name=postgresql state=stopped

    - name: checking /data/services/postgresql
      stat: path=/data/services/postgresql
      register: data_postgresql

    - name: backup existing /data/services/postgresql
      command: mv /data/services/postgresql /data/services/postgresql.back
      when: "{{ data_postgresql.stat.exists }}"

    - name: moving /var/lib/postgresql to /data/services/postgresql
      command: mv -t /data/services /var/lib/postgresql

  when: "{{ var_postgresql_link.state == 'directory' }}"

- name: /var/lib/postgresql symlink
  file:
      path: /var/lib/postgresql
      state: link
      src: /data/services/postgresql

- name: starting postgresql
  service: name=postgresql state=started

- name: postgresql shared memory
  sysctl:
      name: kernel.shmmax
      reload: yes
      sysctl_file: /etc/sysctl.d/30-postgresql-shm.conf
      value: 500000000
  notify: postgresql restart

- name: postgresql network
  augeas:
      command: match
      path: /files/etc/postgresql/9.3/main/postgresql.conf/listen_addresses[ . = '*' ]
  register: listen_addresses

- name: postgresql network
  augeas:
      command: match
      path: "/files/etc/postgresql/9.3/main/postgresql.conf/#comment[ . =~ regexp('.*listen_addresses.=..*') ]"
  register: listen_addresses_comment

- name: postgresql network
  augeas:
      commands: set /files/etc/postgresql/9.3/main/postgresql.conf/listen_addresses *
  notify: postgresql restart
  when: listen_addresses.result|length == 0 and listen_addresses_comment.result|length == 0

- name: postgresql network
  augeas:
      commands: |
          ins listen_addresses before {{ listen_addresses_comment.result[0].label }}
          set /files/etc/postgresql/9.3/main/postgresql.conf/listen_addresses *
  notify: postgresql restart
  when: listen_addresses.result|length == 0 and listen_addresses_comment.result|length != 0

- name: postgresql security (postgres/local)
  augeas:
      command: match
      path: "/files/etc/postgresql/9.3/main/pg_hba.conf/*[type='local'][database='all'][user='postgres'][method='trust']"
  register: local_postgres_trust

- name: postgresql security (postgres/local)
  augeas:
      command: match
      path: "/files/etc/postgresql/9.3/main/pg_hba.conf/*[type='local'][database='all'][user='postgres']"
  register: local_postgres

- name: postgresql security (postgres/local)
  augeas:
      commands: |
          ins 01 before /files/etc/postgresql/9.3/main/pg_hba.conf/1
          set /files/etc/postgresql/9.3/main/pg_hba.conf/01/type local
          set /files/etc/postgresql/9.3/main/pg_hba.conf/01/database all
          set /files/etc/postgresql/9.3/main/pg_hba.conf/01/user postgres
          set /files/etc/postgresql/9.3/main/pg_hba.conf/01/method trust
  notify: postgresql restart
  when: local_postgres_trust.result|length == 0 and local_postgres.result|length == 0

- name: postgresql security (postgres/local)
  augeas:
      commands: |
          set {{ local_postgres.result[0].label }}/method trust
  notify: postgresql restart
  when: local_postgres_trust.result|length == 0 and local_postgres.result|length != 0

- name: postgresql security (all/local)
  augeas:
      command: match
      path: "/files/etc/postgresql/9.3/main/pg_hba.conf/*[type='local'][database='all'][user='all'][method='trust']"
  register: local_all_trust

- name: postgresql security (all/local)
  augeas:
      command: match
      path: "/files/etc/postgresql/9.3/main/pg_hba.conf/*[type='local'][database='all'][user='all']"
  register: local_all

- name: postgresql security (all/local)
  augeas:
      commands: |
          ins 01 before /files/etc/postgresql/9.3/main/pg_hba.conf/1
          set /files/etc/postgresql/9.3/main/pg_hba.conf/01/type local
          set /files/etc/postgresql/9.3/main/pg_hba.conf/01/database all
          set /files/etc/postgresql/9.3/main/pg_hba.conf/01/user all
          set /files/etc/postgresql/9.3/main/pg_hba.conf/01/method trust
  notify: postgresql restart
  when: local_all_trust.result|length == 0 and local_all.result|length == 0

- name: postgresql security (all/local)
  augeas:
      commands: |
          set {{ local_all.result[0].label }}/method trust
  notify: postgresql restart
  when: local_all_trust.result|length == 0 and local_all.result|length != 0

- name: postgresql security (all/network)
  augeas:
      command: match
      path: "/files/etc/postgresql/9.3/main/pg_hba.conf/*[type='host'][database='all'][user='all'][address='0.0.0.0/0'][method='md5']"
  register: network_all_trust

- name: postgresql security (all/network)
  augeas:
      command: match
      path: "/files/etc/postgresql/9.3/main/pg_hba.conf/*[type='host'][database='all'][user='all'][address='0.0.0.0/0']"
  register: network_all

- name: postgresql security (all/network)
  augeas:
      commands: |
          ins 01 after /files/etc/postgresql/9.3/main/pg_hba.conf/*[type=\'host\'][last()]
          set /files/etc/postgresql/9.3/main/pg_hba.conf/01/type host
          set /files/etc/postgresql/9.3/main/pg_hba.conf/01/database all
          set /files/etc/postgresql/9.3/main/pg_hba.conf/01/user all
          set /files/etc/postgresql/9.3/main/pg_hba.conf/01/address 0.0.0.0/0
          set /files/etc/postgresql/9.3/main/pg_hba.conf/01/method md5
  notify: postgresql restart
  when: network_all_trust.result|length == 0 and network_all.result|length == 0

- name: postgresql security (all/network)
  augeas:
      commands: |
          set {{ network_all.result[0].label }}/method md5
  notify: postgresql restart
  when: network_all_trust.result|length == 0 and network_all.result|length != 0
